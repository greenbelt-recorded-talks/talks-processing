{% extends 'base.html' %}

{% block content %}

<h1 class="uk-heading-line uk-text-center"><span>Talks Front Desk</span></h1>

<div class="uk-card uk-card-body uk-card-default">

<h1> Front Desk </h1>

The talks below are the ones that have started, but that RAW files haven't yet been uploaded for.

If you have a recorder notes photo, upload this first, as the talk will disappear from this list when the RAW file is uploaded

<table>
<tr>
	<th>Talk ID</th>
        <th>Day</th>
	<th>Time</th>
        <th>Venue</th>
        <th>Speaker</th>
        <th>Title</th>
	<th>RAW file</th>
	<th>Recorder Notes Photo</th>
</tr>
{% for talk in talks_to_upload %}
{% if talk.id not in raw_talks_available %}
<tr>
	<td>{{ talk.id }}</td>
        <td>{{ talk.day }}</td>
        <td>{{ talk.start_time.strftime("%H:%M") }}</td>
        <td>{{ talk.venue }}</td>
        <td>{{ talk.speaker }}</td>
        <td>{{ talk.title }}</td>
	<td>
		<form class="upload-form" data-talk-id="{{ talk.id }}" data-file-type="raw">
                	<input name="file" type="file" accept=".mp3,.mp4,.mov,.avi,.mkv,.m4a,.wav" required>
                        <button type="submit" class="uk-button uk-button-primary">
                            <span class="button-text">Upload</span>
                            <div uk-spinner="ratio: 0.5" class="upload-spinner" style="display: none;"></div>
                        </button>
                </form>
                <div class="upload-status" style="margin-top: 8px;"></div>
                <small class="uk-text-muted">Supports audio (MP3, WAV, M4A) and video files (MP4, MOV, AVI, MKV)</small>
	</td>
	<td>
                <form method=post enctype=multipart/form-data name=upload_photo action=uploadrecordernotes>
                        <input name=file type=file id=file accept=".jpg">
                        <input name=talk_id type=hidden value="{{talk.id}}">
                        <button>Upload</button>
                </form>
        </td>
	</form>
</tr>
<tr>
	<td colspan="8"><hr /></td>
</tr>
{% endif %}
{% endfor %}
</table>

</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle upload form submissions
    document.querySelectorAll('.upload-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = this.querySelector('input[type="file"]');
            const button = this.querySelector('button');
            const buttonText = button.querySelector('.button-text');
            const spinner = button.querySelector('.upload-spinner');
            const statusDiv = this.parentNode.querySelector('.upload-status');
            const talkId = this.dataset.talkId;
            const fileType = this.dataset.fileType;
            
            // Check if file is selected
            if (!fileInput.files.length) {
                showStatus(statusDiv, 'Please select a file', 'error');
                return;
            }
            
            // Show spinner and disable button
            buttonText.style.display = 'none';
            spinner.style.display = 'inline-block';
            button.disabled = true;
            statusDiv.innerHTML = '';
            
            // Create FormData
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('talk_id', talkId);
            formData.append('file_type', fileType);
            
            // Upload file
            fetch('/uploadtalk_ajax', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus(statusDiv, data.message, 'success');
                    // Clear the file input
                    fileInput.value = '';
                    // Optionally hide the form since file is uploaded
                    setTimeout(() => {
                        this.style.display = 'none';
                        statusDiv.innerHTML = '<span class="uk-text-success">âœ“ File uploaded</span>';
                    }, 2000);
                } else {
                    showStatus(statusDiv, data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                showStatus(statusDiv, 'Upload failed. Please try again.', 'error');
            })
            .finally(() => {
                // Hide spinner and re-enable button
                buttonText.style.display = 'inline';
                spinner.style.display = 'none';
                button.disabled = false;
            });
        });
    });
    
    function showStatus(element, message, type) {
        const alertClass = type === 'error' ? 'uk-alert-danger' : 'uk-alert-success';
        element.innerHTML = `
            <div class="uk-alert ${alertClass}" uk-alert>
                <a class="uk-alert-close" uk-close></a>
                <p>${message}</p>
            </div>
        `;
    }
});
</script>
{% endblock %}


